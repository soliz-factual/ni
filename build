#!/bin/bash
# Builds the core ni image from the files in src/.
cd $(dirname $0)

boot_image() {
  cat src/boot \
      src/lib/behavior \
      src/lib/class \
      src/lib/fn \
      src/lib/image \
      src/lib/self
}

install_stuff() {
  perl ni0 --internal/+= \
    src/lib/doc \
    src/doc/internal/class \
    src/unix/io \
    src/unix/fd \
    src/unix/file \
    src/unix/pid
}

boot_build() {
  boot_image > ni0
  echo "initially $(wc -c < ni0) bytes"

  $1

  echo "       >> $(wc -c < ni0) bytes"
  perl ni0 --internal/image > ni && cp ni ni0 || exit $?
  echo "       >> $(wc -c < ni0) bytes"
  perl ni0 --internal/image > ni && cp ni ni0 || exit $?
  echo "       >> $(wc -c < ni0) bytes"
  perl ni0 --internal/image > ni || exit $?
  echo "       >> $(wc -c < ni) bytes"

  if [[ "$(<ni0)" != "$(<ni)" ]]; then
    echo 'ni is unstable under replication; diff in ni.diff'
    [[ -n "$(<ni0)" ]] && [[ -n "$(<ni)" ]] \
      && diff -C 3 ni0 ni > ni.diff
    exit 1
  else
    rm ni0
  fi

  chmod 755 ni
}

time_n() {
  n=$1
  min=none
  shift

  k=$((n / 10))
  date +%s%N > /dev/null
  seq 4 | xargs -n1 -I{} "$@" > /dev/null
  for i in `seq 10`; do
    start_nanos=$(date +%s%N)
    seq $k | xargs -n1 -I{} "$@" > /dev/null
    end_nanos=$(date +%s%N)

    if [[ $min == none ]] || (( (end_nanos - start_nanos) < min )); then
      min=$((end_nanos - start_nanos))
    fi
  done
  echo "$(( (end_nanos - start_nanos) / (k * 1000) ))Î¼s"
}

case $1 in
boot)
  boot_image > ni0
  ;;

bench)
  boot_build :
  boot_image > ni0
  echo "original: $(time_n 200 perl ni0 --internal/eval 1) overhead"
  echo "compiled: $(time_n 200 perl ni  --internal/eval 1) overhead"

  rm ni0
  boot_build install_stuff
  echo "full: $(time_n 200 perl ni --internal/eval 1) overhead"
  ;;

*)
  boot_build install_stuff
  ;;
esac
